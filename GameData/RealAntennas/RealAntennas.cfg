@PART[SurfAntenna]:HAS[@MODULE[ModuleDataTransmitter]]
{
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		referenceGain = 2.0
	}
}

@PART[longAntenna]:HAS[@MODULE[ModuleDataTransmitter]]
{
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		referenceGain = 3.0
	}
}


@PART[commDish]:HAS[@MODULE[ModuleDataTransmitter]]
{
	@title = 4.8 m Folded Parabolic Antenna
	%rescaleFactor = 2.1573
	%rescaleFactor:NEEDS[ReStock] = 2.2326
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 4.8
	}
}

!PART[mediumDishAntenna]

@PART[HighGainAntenna]:HAS[@MODULE[ModuleDataTransmitter]]
{
	@title = 1.22 m Retractable Parabolic Antenna
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 1.22
	}
}

@PART[HighGainAntenna5]:HAS[@MODULE[ModuleDataTransmitter]]
{
	@title = 0.5 m Retractable Parabolic Antenna
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 0.5
	}
}

@PART[RelayAntenna5]:HAS[@MODULE[ModuleDataTransmitter]]
{
	@title = 1 m Parabolic Antenna
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 1
//		referenceGain = 25.36
//		referenceFrequency = 2295
	}
}

@PART[RelayAntenna50]:HAS[@MODULE[ModuleDataTransmitter]]
{
	@title = 2 m Parabolic Antenna
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 2
	}
}

@PART[RelayAntenna100]:HAS[@MODULE[ModuleDataTransmitter]]
{
	%rescaleFactor = 1.3333
	%rescaleFactor:NEEDS[ReStock] = 1.3115
	
	@title = 4 m Parabolic Antenna
	
	!MODULE[ModuleDataTransmitter],* {}
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 4
	}
}

//
// now to the generic patches
//
// these patches apply after the dedicated patches, which are FOR[RealAntennas]

@PART[*]:HAS[@MODULE[ModuleDataTransmitter]:HAS[~antennaType[]],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:BEFORE[zRealAntennas]
{
	@MODULE[ModuleDataTransmitter]
	{
		antennaType = INTERNAL
	}
}

// when it was an INTERNAL we assume it's a (built-in) low gain telemetry antenna
@PART[*]:HAS[@MODULE[ModuleDataTransmitter]:HAS[#antennaType[INTERNAL]],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:FOR[zRealAntennas]
{
	MODULE
	{
		name = ModuleRealAntenna
		referenceGain = 1.0
	}
}

// when it was a DIRECT without ModuleCommand and without ModuleAvionics we assume it's a dedicated omni antenna with higher gain than built-in omni antennas
@PART[*]:HAS[@MODULE[ModuleDataTransmitter]:HAS[#antennaType[DIRECT]],!MODULE[ModuleCommand],!MODULE[ModuleAvionics],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:FOR[zRealAntennas]
{
	MODULE
	{
		name = ModuleRealAntenna
		referenceGain = 2.0
	}
}

// when it was a DIRECT with ModuleCommand we assume it's a built-in omni antenna with lower gain than dedicated omni antennas
@PART[*]:HAS[@MODULE[ModuleDataTransmitter]:HAS[#antennaType[DIRECT]],@MODULE[ModuleCommand],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:FOR[zRealAntennas]
{
	MODULE
	{
		name = ModuleRealAntenna
		referenceGain = 1.5
	}
}

// when it was a RELAY we assume it's a dish for now
@PART[*]:HAS[@MODULE[ModuleDataTransmitter]:HAS[#antennaType[RELAY]],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:FOR[zRealAntennas]
{
	MODULE
	{
		name = ModuleRealAntenna
		antennaDiameter = 1.0
	}
}

// Kerbals on EVA get a low gain antenna built in their space suit
// to have other patches like from Kerbalism kick in as well, we add a dummy stock antenna
// that one will be removed later, see below
// we also have to add ElectricCharge as resource
// @PART[kerbalEVA*]:HAS[!MODULE[ModuleDataTransmitter],!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],@MODULE[ModuleTripLogger]]
// {
	// %RESOURCE[ElectricCharge]
	// {
		// %amount = 10
		// %maxAmount = 10
	// }

	// MODULE
	// {
		// name = ModuleDataTransmitter
		// antennaType = DIRECT
		// packetInterval = 0.2
		// packetSize = 1.35
		// packetResourceCost = 0.375
		// requiredResource = ElectricCharge
		// antennaPower = 35000
		// optimumRange = 5000
		// packetFloor = 0.1
		// packetCeiling = 5
	// }
// }

// now the RA module will be added
// @PART[kerbalEVA*]:HAS[!MODULE[ModuleConfigurableAntenna],!MODULE[ModuleRealAntenna],@MODULE[ModuleTripLogger]]:FOR[zRealAntennas]
// {
	// MODULE
	// {
		// name = ModuleRealAntenna
		// referenceGain = 1.0
		// RFBand = L
		// TxPower = 10
		// TechLevel = 1
	// }
// }

// for any part that got ModuleRealAntenna now and still got ModuleDataTransmitter we remove ModuleDataTransmitter
@PART[*]:HAS[@MODULE[ModuleRealAntenna],@MODULE[ModuleDataTransmitter]]:AFTER[zRealAntennas]
{
	!MODULE[ModuleDataTransmitter],* { }
}

@PART[*]:HAS[@MODULE[ModuleRealAntenna],!MODULE[KerbalEVA]]:FOR[zRealAntennas]
{
	@MODULE[ModuleRealAntenna],*
	{
		%RFBand = L
		UPGRADES
		{
			UPGRADE
			{
				name__ = commsTL1
				maxTechLevel = 1
			}
			UPGRADE
			{
				name__ = commsTL2
				maxTechLevel = 2
			}
			UPGRADE
			{
				name__ = commsTL3
				maxTechLevel = 3
			}
			UPGRADE
			{
				name__ = commsTL4
				maxTechLevel = 4
			}
			UPGRADE
			{
				name__ = commsTL5
				maxTechLevel = 5
			}
			UPGRADE
			{
				name__ = commsTL6
				maxTechLevel = 6
			}
			UPGRADE
			{
				name__ = commsTL7
				maxTechLevel = 7
			}
			UPGRADE
			{
				name__ = commsTL8
				maxTechLevel = 8
			}
			UPGRADE
			{
				name__ = commsTL9
				maxTechLevel = 9
			}
		}
	}
}

@PART[*]:HAS[@MODULE[ModuleRealAntenna]]:FINAL
{
	@MODULE[ModuleRealAntenna]
	{
		// @antennaType = RELAY // what is this for?
		!antennaType = delete
		!packetInterval = delete
		!packetSize = delete
		!packetResourceCost = delete
		!requiredResource = ElectricCharge
		!antennaPower = 100000
		!optimumRange = 2500
		!packetFloor = .1
		!packetCeiling = 5
	}
}
